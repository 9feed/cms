<div data-scope="pages" class="container">
	<div class="toolbar">
		<button class="right exec highlight" data-exec="?/create"><i class="fa fa-plus-circle"></i>@(Create)</button>
		<button class="exec" data-exec="?/options"><i class="fa fa-cogs"></i>@(Options)</button>
		<span></span>
		<button class="exec" data-exec="?/checked" name="checked" disabled="disabled"><i class="fa fa-check-circle"></i>@(Checked)</button>
	</div>
	<div class="fullheight">
		<div data---="datagrid__?.grid__padding:10;filterlabel:@(Search);checked:?/checkbox;button:?/button">
			<script type="text/plain">
			[
				{ name: 'path', text: '@(Name)', width: 300, template: '{{ language | language }}{{ if icon }}<i class="{{ icon }} mr5"></i>{{ fi }}{{ path | pagespath }}{{ if draft }}<span class="badge badge-red ml5">@(draft)</span>{{ fi }}{{ if ispartial }}<span class="badge badge-green ml5">@(partial)</span>{{ fi }}', classth: 'left', classfilter: 'left' },
				{ name: 'url', text: '@(URL address)', width: 230, template: '{{ if ispartial }}<span class="silver">{{ url }}</span>{{ else }}{{ url }}{{ fi }}', class: 'hidden-xs' },
				{ name: 'language', text: '<i class="fa fa-flag" style="margin-right:0"></i>', width: 50, title: '@(Language)', sort: false, align: 1, filter: ' ' },
				{ name: 'dtupdated', text: '@(Updated)', format: '[date]', width: 100, sort: false, align: 1 },
				{ name: '@(Options)', filter: false, align: 2, sort: false, width: 150, template: '{{ if !ispartial }}<a href="{{ url }}" class="fs11 mr5" target="_blank">@(show)</a>{{ fi }}<div class="inline mr10"><button title="@(Duplicate)" name="duplicate"><i class="far fa-copy"></i></button><button name="update" title="@(Edit)"><i class="fa fa-pencil"></i></button><button class="btn-remove" name="remove" title="@(Remove)"><i class="far fa-trash-o"></i></button></div>' }
			]
			</script>
		</div>
	</div>
</div>

<div data---="importer__common.form__if:pages-form;url:[url]forms/pages.html;cleaner:5"></div>
<div data---="importer__common.form__if:pages-navigation;url:[url]forms/pages-navigation.html;cleaner:5"></div>
<div data---="importer__common.form2__if:pages-navigation-item;url:[url]forms/pages-navigation-item.html;cleaner:5"></div>
<div data---="importer__common.form__if:pages-redirects;url:[url]forms/pages-redirects.html;cleaner:5"></div>

<script>
	PLUGIN('pages', function(exports) {

		var toolbar = { btnChecked: exports.element.find('.toolbar button[name="checked"]') };

		exports.refresh = function() {

			FUNC.loading(true);

			AJAX('GET [url]api/pages/', function(response) {

				for (var i = 0, length = response.items.length; i < length; i++) {
					var item = response.items[i];
					var parent = item.parent;
					var path = item.name;
					var is = false;

					while (parent) {
						var sub = response.items.findItem('id', parent);
						if (!sub || sub.url === '/')
							break;
						path = sub.name + ' / ' + path;
						parent = sub.parent;
						is = true;
					}

					item.path = path;
				}

				var cdl = response.items.slice(0).map(function(item) {
					return { id: item.id, ispartial: item.ispartial, name: (item.language ? (item.language + ': ') : '') + item.path, url: item.url };
				});

				cdl.quicksort('name');
				SET('?.grid', response);
				SET('?.list', cdl);
				FUNC.loading(false, 200);
			});
		};

		// Public methods
		exports.reload = function() {
			exports.refresh();
		};

		exports.button = function(name, row, grid) {
			switch (name) {
				case 'remove':
					SETTER('confirm', 'show', '@(Are you sure you want to remove selected page?)', ['"trash"@(Remove)', '@(No)'], function(index) {
						if (!index) {
							FUNC.loading(true);
							AJAX('DELETE [url]api/pages/', row, AJAX('DELETE [url]api/pages/', row, FUNC.messageresponse('@(Pages has been removed successfully)', exports.refresh)));
						}
					});
					break;
				case 'update':
				case 'duplicate':
					FUNC.loading(true);
					AJAX('GET [url]api/pages/{id}/'.arg(row), function(response) {

						if (name === 'duplicate') {

							response.id = '';

							// Clear existing parts
							setTimeout(function() {
								SETTER('cmseditor', 'clearParts');
							}, 1000);

						}

						response.bodycurrent = response.body;

						if (response.draft)
							response.body = response.bodydraft;

						SET('cmseditor.css', response.css);
						SET('cmseditor.template', response.template);

						SET('?.form', response, true);
						SET('common.form', 'pages-form');
					});

					break;
			}
		};

		exports.checkbox = function(el, grid) {
			el && !el.value && grid.checked(el.checked);
			var count = grid.checked().length;
			toolbar.btnChecked.prop('disabled', count === 0);
		};

		exports.checked = function(el) {
			var options = {};
			options.element = el;
			options.items = [];
			options.items.push({ id: 'remove', name: '@(Remove pages)', icon: 'trash' });

			options.callback = function(item) {
				switch (item.id) {
					case 'remove':
						SETTER('confirm', 'show', '@(Are you sure you want to remove all selected pages?)', ['"trash"@(Remove)', '@(No)'], function(index) {
							if (index)
								return;
							FUNC.loading(true);
							var arr = FIND('.pages.grid').checked();
							arr.wait(function(el, next, index) {
								SET('common.progress', (index / arr.length) * 100);
								AJAX('DELETE [url]api/pages/', { id: el.id }, next);
							}, function() {
								exports.refresh();
								FUNC.loading(false, 1000);
								SETTER('snackbar', 'success', '@(Pages have been removed successfully.)');
							});
						});
						break;
				}
			};

			SETTER('menu', 'show', options);
		};

		exports.options = function(el) {
			var options = {};
			options.items = [];
			options.items.push({ id: 'create', name: '@(Create page)', icon: 'plus-circle', classname: 'b' });
			options.items.push({ id: 'refresh', name: '@(Refresh)', icon: 'refresh' });
			options.items.push('-');
			options.items.push({ value: 'pages-globals', name: '@(Variables)', icon: 'cog' });
			options.items.push({ value: 'widgets-globals', name: '@(Global style/script)', icon: 'paint-brush' });
			options.element = el;

			options.callback = function(item) {
				if (item.id)
					exports[item.id]();
				else
					SET('common.form', item.value);
			};

			SETTER('menu', 'show', options);
		};

		exports.globals = function(el) {
			SET('?.formglobals', {}, true);
			SET('common.form', 'pages-globals');
		};

		exports.navigation = function(el) {
			AJAX('GET [url]api/nav/{0}/'.format(el.attrd('id')), function(response) {
				FUNC.loading(false, 1000);
				SET('?.navigation', response, true);
				SET('common.form', 'pages-navigation');
			});
		};

		exports.create = function() {
			SET('?.form', { widgets: [], ispartial: false, navicon: true, navname: true, replacelink: true, url: '---' }, true);
			SET('common.form', 'pages-form');
		};

	});

	Thelpers.pagespath = function(value) {
		var arr = value.split('/');
		var builder = [];

		for (var i = 0; i < arr.length - 1; i++) {
			var path = arr[i];
			builder.push('<span class="silver">{0} /</span>'.format(path.trim()));
		}

		return (builder.length ? (builder.join('')) : '') + arr.last();
	};

</script>