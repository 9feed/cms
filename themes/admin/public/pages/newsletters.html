<div data-scope="newsletters" class="container">
	<div class="toolbar">
		<button class="right exec highlight hidden-xs" data-exec="?/create"><i class="fa fa-plus-circle"></i>@(Create)</button>
		<button class="exec" data-exec="?/options"><i class="fa fa-cogs"></i>@(Options)</button>
		<span></span>
		<button class="exec" data-exec="?/checked" name="checked" disabled="disabled"><i class="fa fa-check-circle"></i>@(Checked)</button>
		<div class="fs12 red ml5" data-bind="newsletters.state.sending__show:value"><i class="fa fa-spin fa-refresh mr5"></i>@(Sending) (<b data-bind="newsletters.state.percentage__html:value + '%'"></b>)</div>
	</div>
	<div class="fullheight">
		<div data-jc="datagrid__?.grid__padding:10;filterlabel:@(Search);checked:?/checkbox;button:?/button;pagination:true">
			<script type="text/plain">
			[
				{ name: 'name', text: '@(Name)', width: 300, template: '{{ if issent }}<span class="badge badge-green mr5">@(send)</span>{{ fi }}{{ name }}', classth: 'left', classfilter: 'left' },
				{ name: 'count', text: '@(Subscribers)', align: 2, width: 140, class: 'hidden-xs', template: '{{ count }}x<i class="fa fa-envelope-o ml5"></i>' },
				{ name: 'datecreated', text: '@(Created)', width: 200, align: 1, class: 'hidden-xs', template: '{{ datecreated | format(\'yyyy-MM-dd HH:mm\') }}' },
				{ name: '@(Options)', align: 2, filter: false, sort: false, width: 150, template: '<div class="inline mr10"><button title="@(Duplicate)" name="duplicate"><i class="far fa-copy"></i></button><button name="update" title="@(Edit)"><i class="fa fa-pencil"></i></button><button class="btn-remove" name="remove" title="@(Remove)"><i class="far fa-trash-o"></i></button></div>' }
			]
			</script>
		</div>
	</div>
</div>
<div data-jc="importer__common.form__if:newsletters-form;url:[url]forms/newsletters.html;cleaner:5"></div>

<script>

	PLUGIN('newsletters', function(exports) {

		var toolbar = { btnChecked: exports.element.find('.toolbar button[name="checked"]') };

		exports.refresh = function() {

			FUNC.loading(true);

			AJAX('GET [url]api/newsletters/', function(response) {
				SET('?.grid', response);
				FUNC.loading(false, 500);
			});
		};

		exports.state = function() {
			AJAX('GET [url]api/newsletters/state/', function(response) {
				SET('?.state', response);
				response.sending && !exports.removed && setTimeout(exports.state, 5000);
			});
		};

		exports.reload = function() {
			exports.refresh();
			exports.state();
		};

		exports.button = function(name, row, grid) {
			switch (name) {
				case 'remove':
					SETTER('confirm', 'show', '@(Are you sure you want to remove selected newsletter?)', ['"trash"@(Remove)', '@(No)'], function(index) {
						if (!index) {
							FUNC.loading(true);
							AJAX('DELETE [url]api/newsletters/', row, function(response) {
								FUNC.loading(false, 1000);
								if (response.success) {
									SETTER('snackbar', 'success', '@(Newsletter has been removed successfully.)');
									exports.refresh();
								}
							});
						}
					});
					break;
				case 'update':
				case 'duplicate':
					FUNC.loading(true);
					AJAX('GET [url]api/newsletters/{id}/'.arg(row), function(response) {

						if (name === 'duplicate') {
							response.id = '';
							response.count = 0;
							response.send = false;
							response.issent = false;
						} else
							SKIP('?.form.stats');

						SET('cmseditor.template', response.template);
						SET('?.form', response, true);
						SET('common.form', 'newsletters-form');
					});
					break;
			}
		};

		exports.checkbox = function(el, grid) {
			el && !el.value && grid.checked(el.checked);
			var count = grid.checked().length;
			toolbar.btnChecked.prop('disabled', count === 0);
		};

		exports.checked = function(el) {
			var items = [];
			items.push({ id: 'remove', name: '@(Remove newsletters)', icon: 'trash' });
			SETTER('contextmenu', 'show', 'center', el, items, function(item) {
				switch (item.id) {
					case 'remove':
						SETTER('confirm', 'show', '@(Are you sure you want to remove all selected newsletters?)', ['"trash"@(Remove)', '@(No)'], function(index) {
							if (index)
								return;
							var arr = FIND('.newsletters.grid').checked();
							FUNC.loading(true);
							arr.wait(function(el, next, index) {
								SET('common.progress', (index / arr.length) * 100);
								AJAX('DELETE [url]api/newsletters/', { id: el.id }, next);
							}, function() {
								exports.refresh();
								FUNC.loading(false, 1000);
								SETTER('snackbar', 'success', '@(Newsletters have been removed successfully.)');
							});
						});
						break;
				}
			}, 0, 5);
		};

		exports.options = function(el) {
			var items = [];
			items.push({ id: 'refresh', name: '@(Refresh)', icon: 'refresh' });
			items.push({ id: 'create', name: '@(Create newsletter)', icon: 'plus-circle' });
			SETTER('contextmenu', 'show', 'left', el, items, function(item) {
				switch (item.id) {
					case 'refresh':
					case 'create':
						exports[item.id]();
						break;
				}
			}, 2, 5);
		};

		exports.create = function() {
			SET('?.form', { widgets: [], limit: 1500 }, true);
			SET('common.form', 'newsletters-form');
		};

	});

</script>