<div data-scope="settings" class="scroller fullheight" data-margin="-20">

	<br />
	<div class="container">
		<div class="panel">
			<label>@(Main settings)</label>
			<div class="panelbody">
				<div data---="input__?.form.url__required:true;placeholder:@(https://eshop.totaljs.com)" class="m">@(URL address)</div>
				<div class="row">
					<div class="col-md-4 col-sm-4 m">
						<div data---="input__?.form.emailsender__required:true;type:email">@(Email for sending)</div>
					</div>
					<div class="col-md-4 col-sm-4 m">
						<div data---="input__?.form.emailcontactform__required:true;type:email">@(Email for contact form)</div>
					</div>
					<div class="col-md-4 col-sm-4 m">
						<div data---="input__?.form.emailreply__required:true;type:email">@(Email for answers)</div>
					</div>
				</div>
				<hr />
				<div data---="checkbox__?.form.componentator">@(Allow to download widgets from <b>componentator.com</b>)</div>
			</div>
		</div>
	</div>
	<br />
	<br />

	<div data-bind="user__show:value.sa">

		<div class="container">

			<div class="tabmenu-container">
				<ul data---="tabmenu__?.tab__null__'templates'" class="tabmenu tabmenu-bordered">
					<li data-value="templates">@(Templates)</li>
					<li data-value="categories">@(Categories)</li>
					<li data-value="misc">@(Miscellaneous)</li>
					<li data-value="smtp"><i class="fa fa-envelope"></i>@(SMTP)</li>
					<li data-value="services"><i class="fa fa-cogs"></i>@(Services)</li>
				</ul>
			</div>

			<div class="panel" style="border-radius:0 0 3px 3px;border-top:0">
				<div class="hidden panelbody" data-bind="?.tab__show:value==='templates'">
					<div data---="keyvalue__?.form.templates__placeholderkey:@(A template name);placeholdervalue:@(Type a view name)__{}">@(Page templates)</div>
					<br />
					<div data---="keyvalue__?.form.templatesposts__placeholderkey:@(A template name);placeholdervalue:@(Type a view name)__{}">@(Post templates)</div>
					<br />
					<div data---="keyvalue__?.form.templatesnewsletters__placeholderkey:@(A template name);placeholdervalue:@(Type a view name)__{}">@(Newsletter templates)</div>
					<br />
					<div class="help nmt"><i class="fa fa-warning"></i>@(All templates need to be created manually in <code>/themes/THEME_NAME/views/cms/</code> directory.)</div>
				</div>

				<div class="hidden panelbody" data-bind="?.tab__show:value==='categories'">
					<div data---="keyvalue__?.form.posts__placeholderkey:@(A category name);placeholdervalue:@(Type an identificator and press enter)">@(Posts categories)</div>
					<div class="help">@(Global variable: <code>MAIN.posts</code>)</div>
					<br />
					<div data---="keyvalue__?.form.notices__placeholderkey:@(A category name);placeholdervalue:@(Type an identificator and press enter)">@(Notices categories)</div>
					<div class="help">@(Global variable: <code>MAIN.notices</code>)</div>
				</div>

				<div class="hidden panelbody" data-bind="?.tab__show:value==='misc'">
					<div data---="keyvalue__?.form.navigations__placeholderkey:@(A navigation name);placeholdervalue:@(Type an identificator and press enter)">@(Navigations)</div>
					<div class="help">@(Global variable: <code>MAIN.navigations.IDENTIFICATOR</code>)</div>
					<br />
					<div data---="keyvalue__?.form.languages__placeholderkey:@(A language name);placeholdervalue:@(Type an identificator (e.g. en, de, fr) and press enter)">@(Languages)</div>
					<br />
					<div data---="keyvalue__?.form.signals__placeholderkey:@(A signal name);placeholdervalue:@(Type an identificator and press enter)">@(Signals)</div>
					<div class="help">@(Signals can affect a behaviour in pages or posts.)</div>
				</div>

				<div class="hidden panelbody" data-bind="?.tab__show:value==='smtp'">
					<br />
					<div class="row">
						<div class="col-md-6 m">
							<div data---="input__?.form.smtp__icon:server;placeholder:@(smtp.yourdomain.com)">@(SMTP server)</div>
							<div class="help">@(IP address or hostname.)</div>
						</div>
						<div class="col-md-6 m">
							<div data---="input__?.form.smtpoptions__icon:code;placeholder:@(SMTP options)">@(SMTP options)</div>
							<div class="help">@(Options need to be defined in JSON format according.) <a href="https://docs.totaljs.com/latest/en.html#api~FrameworkConfiguration~mail-smtp-options" target="_blank">Total.js specification</a></div>
						</div>
					</div>
				</div>

				<div class="hidden panelbody" data-bind="?.tab__show:value==='services'">
					<div class="padding npb">
						<div class="row">
							<div class="col-sm-3 m">
								<div class="padding bg-smoke">
									<h3 class="nmb">@(Backups)</h3>
									<p>@(This operation will remove all backed up records from all database.)</p>
									<button class="button button-small b exec" data-exec="settings/operation" data-name="backups"><i class="fa fa-trash-o mr5"></i>@(Clear backups)</button>
								</div>
							</div>
							<div class="col-sm-3 m">
								<div class="padding bg-smoke">
									<h3 class="nmb">@(Files)</h3>
									<p>@(This operation will remove all files which aren't used in the content.)</p>
									<button class="button button-small b exec" data-exec="settings/operation" data-name="files"><i class="fa fa-trash-o mr5"></i>@(Clear files)</button>
								</div>
							</div>
							<div class="col-sm-3 m">
								<div class="padding bg-smoke">
									<h3 class="nmb">@(Events)</h3>
									<p>@(This operation will remove all recorded events in <b>Events section</b>.)</p>
									<button class="button button-small b exec" data-exec="settings/operation" data-name="events"><i class="fa fa-trash-o mr5"></i>@(Clear events)</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<br />

	<div class="container">
		<br />
		<div class="help nmt">@(List of all administrators:)</div>
		<div class="mt5"><span class="link exec" data-exec="settings/create"><i class="fa fa-user mr5"></i>@(Add a new administrator)</span></div>
		<br />
		<table class="table ui-table-grid">
			<tbody data---="repeater__?.form.users">
				<script type="text/html">
				<tr data-index="{{ index }}">
					<td>{{ name }}</td>
					<td style="width:300px" class="active hidden-xs fs11"><div class="singleline"><i class="fa fa-lock mr5"></i>{{ if roles && roles.length }}{{ roles | join(', ') }}{{ else }}<b class="b">@(Full privileges)</b>{{ fi }}</div></td>
					<td style="width:80px" class="center">
						<button name="edit" title="@(Edit)" class="exec" data-exec="settings/edit"><i class="fa fa-pencil"></i></button>
						<button name="remove" title="@(Remove)" class="exec btn-remove" data-exec="settings/remove"><i class="fa fa-times"></i></button>
					</td>
				</tr>
				</script>
			</tbody>
		</table>
		<hr style="border-color:#D0D0D0" />
		<br />
		<div data---="error__?.form.response"></div>
		<div class="row">
			<div class="col-md-4 m col-md-offset-4">
				<div data---="validation__?.form">
					<button class="button b exec" name="submit" disabled="disabled" data-exec="settings/save">@(SAVE SETTINGS)</button>
				</div>
			</div>
		</div>
		<br />
	</div>
</div>
<div data---="importer__common.form__if:settings-admin;url:[url]forms/settings-admin.html;cleaner:5"></div>

<script>

	PLUGIN('settings', function(exports) {

		exports.save = function() {

			// Prepare users
			var data = CLONE(GETR('?.form'));

			var tmp = [];
			Object.keys(data.templates).forEach(function(key) {
				tmp.push({ name: key, id: settings.form.templates[key] });
			});
			data.templates = tmp;

			tmp = [];
			Object.keys(data.templatesposts).forEach(function(key) {
				tmp.push({ name: key, id: data.templatesposts[key] });
			});
			data.templatesposts = tmp;

			tmp = [];
			Object.keys(data.templatesnewsletters).forEach(function(key) {
				tmp.push({ name: key, id: data.templatesnewsletters[key] });
			});
			data.templatesnewsletters = tmp;

			tmp = [];
			Object.keys(data.navigations).forEach(function(key) {
				tmp.push({ name: key, id: data.navigations[key] });
			});
			data.navigations = tmp;

			tmp = [];
			Object.keys(data.posts).forEach(function(key) {
				tmp.push({ name: key, id: data.posts[key] });
			});
			data.posts = tmp;

			tmp = [];
			Object.keys(data.notices).forEach(function(key) {
				tmp.push({ name: key, id: data.notices[key] });
			});
			data.notices = tmp;

			tmp = [];
			Object.keys(data.signals).forEach(function(key) {
				tmp.push({ name: key, id: data.signals[key] });
			});
			data.signals = tmp;

			tmp = [];
			Object.keys(data.languages).forEach(function(key) {
				tmp.push({ name: key, id: data.languages[key] });
			});
			data.languages = tmp;

			FUNC.loading(true);
			AJAX('POST [url]api/settings/ REPEAT', data, function(response) {

				FUNC.loading(false, 1000);
				SET('?.form.response', response);

				if (response instanceof Array)
					return;

				refresh_dependencies();
				SETTER('snackbar', 'success', '@(Settings have been saved successfully.)');
				SET('common.componentator', data.componentator);
			});
		};

		exports.reload = function() {
			AJAX('GET [url]api/settings/', function(response) {

				var tmp = {};
				response.templates && response.templates.forEach(function(item) {
					if (typeof(item) === 'string')
						tmp[item] = item;
					else
						tmp[item.name] = item.id;
				});

				response.templates = tmp;

				tmp = {};
				response.templatesposts && response.templatesposts.forEach(function(item) {
					if (typeof(item) === 'string')
						tmp[item] = item;
					else
						tmp[item.name] = item.id;
				});
				response.templatesposts = tmp;

				tmp = {};
				response.templatesnewsletters && response.templatesnewsletters.forEach(function(item) {
					if (typeof(item) === 'string')
						tmp[item] = item;
					else
						tmp[item.name] = item.id;
				});
				response.templatesnewsletters = tmp;

				tmp = {};
				response.navigations && response.navigations.forEach(function(item) {
					if (typeof(item) === 'string')
						tmp[item] = item;
					else
						tmp[item.name] = item.id;
				});
				response.navigations = tmp;

				tmp = {};
				response.posts && response.posts.forEach(function(item) {
					if (typeof(item) === 'string')
						tmp[item] = item;
					else
						tmp[item.name] = item.id;
				});
				response.posts = tmp;

				tmp = {};
				response.notices && response.notices.forEach(function(item) {
					if (typeof(item) === 'string')
						tmp[item] = item;
					else
						tmp[item.name] = item.id;
				});
				response.notices = tmp;

				tmp = {};
				response.languages && response.languages.forEach(function(item) {
					if (typeof(item) === 'string')
						tmp[item] = item;
					else
						tmp[item.name] = item.id;
				});
				response.languages = tmp;

				tmp = {};
				response.signals && response.signals.forEach(function(item) {
					if (typeof(item) === 'string')
						tmp[item] = item;
					else
						tmp[item.name] = item.id;
				});
				response.signals = tmp;

				SET('?.form', response, true);
			});

		};

		exports.operation = function(el) {
			var type = el.attrd('name');
			SETTER('confirm', 'show', '@(Are you sure you want to perform selected operation?)', ['@(Yes)', '@(Cancel)'], function(index) {
				if (index)
					return;
				AJAX('GET [url]api/{0}/clear/'.format(type), function() {
					SETTER('snackbar', 'success', '@(Done, operation has been completed.)');
				});
			})
		};

		exports.create = function() {
			SET('?.formuser', {}, true);
			SET('common.form', 'settings-admin');
		};

		exports.edit = function(el) {
			SET('?.formuser', CLONE(settings.form.users[+el.closest('tr').attrd('index')]), true);
			SET('common.form', 'settings-admin');
		};

		exports.remove = function(el) {

			var index = +el.closest('tr').attrd('index');
			var users = settings.form.users;
			var user = users[index];

			SETTER('confirm', 'confirm', '@(Are you sure you want to remove the user <b>"{0}"</b>?)'.format(user.name), ['"times-circle" @(Remove)', '@(No)'], function(index) {
				if (!index) {
					users.splice(index, 1);
					UPDATE('?.form.users');
					CHANGE('?.form.url');
				}
			});
		};

	});

</script>